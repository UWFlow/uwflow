# /etc/nginx/nginx.conf

user nginx;

# Based on number of CPU cores
worker_processes auto;

# Faster regexp matching
pcre_jit on;

events {
  worker_connections 1024;
}

http {
  default_type application/json;

  # Compress responses
  gzip on;
  gzip_vary on;

  # PDFs may be large, but should never exceed 10 MiB.
  client_max_body_size 10m;

  # Standard keepalive
  keepalive_timeout 65;

  # Rate-limiting is separate for API and Hasura
  limit_req_zone $binary_remote_addr zone=api:1m rate=10r/s;
  limit_req_zone $binary_remote_addr zone=hasura:1m rate=10r/s;

  # Be efficient with serving static files
  sendfile on;

  # Don't tell nginx version to clients: that would be insecure.
  server_tokens off;

  # Optimize for latency over throughput.
  tcp_nodelay on;

  # Crypto stuff
  include /etc/letsencrypt/config/options-ssl-nginx.conf;
  ssl_certificate /etc/letsencrypt/certificates/$DOMAIN/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/certificates/$DOMAIN/privkey.pem;
  ssl_dhparam /etc/letsencrypt/config/ssl-dhparams.pem;

  upstream api {
    server api:$API_PORT;
  }

  upstream hasura {
    server hasura:$HASURA_PORT;
  }

  server {
    listen $NGINX_HTTP_PORT;
    server_name $DOMAIN;

    location /.well-known/acme-challenge/ {
      root /var/www/certbot;
    }

    location / {
      return 301 https://$server_name$request_uri;
    }
  }

  server {
    listen $NGINX_HTTPS_PORT ssl http2;
    listen $NGINX_HTTPS_PORT quic reuseport;
    server_name $DOMAIN;
    
    location /api {
      limit_req zone=api burst=20 nodelay;

      proxy_pass http://api/data/search;
    }

    location /graphql {
      limit_req zone=hasura burst=20 nodelay;

      proxy_pass http://hasura/v1/graphql;
    }

    location /status {
      stub_status;
    }
  }
}
